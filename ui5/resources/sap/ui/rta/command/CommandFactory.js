/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/base/ManagedObject','sap/ui/dt/ElementUtil','sap/ui/dt/OverlayUtil','sap/ui/dt/OverlayRegistry','sap/ui/fl/Utils','sap/ui/dt/Util','sap/base/util/merge'],function(M,E,O,a,F,D,m){"use strict";function e(x,y){var B=O.getAggregationInformation(x);if(B.elementId){var z=a.getOverlay(B.elementId);var P=z.getParentElementOverlay();var A=P?O.isInAggregationBinding(P,P.sParentAggregationName):false;if(A){throw D.createError("CommandFactory#evaluateTemplateBinding","Multiple template bindings are not supported","sap.ui.rta");}var T=E.extractTemplateId(B);if(T){return{templateSelector:B.elementId,originalSelector:T,content:{boundAggregation:B.aggregation}};}}return undefined;}function g(x){var y=(typeof x==="string")?sap.ui.getCore().byId(x):x;var z=a.getOverlay(y);if(z){var B=O.getAggregationInformation(z);return E.extractTemplateId(B);}else{return y.getId();}}function b(x){if(!x){throw new Error("adjustment for template failed");}}function c(x,y,A){var z;var J=false;if(typeof(A)==="string"){z=A;}else{z=A&&A.changeType;J=A&&A.jsOnly;}if(!z){return false;}y.setChangeType(z);y.setJsOnly(J);return true;}function d(x,S,y){var A={changeType:"addXML"};if(y){jQuery.extend(A,y.getAction("addXML",x));}return A;}function f(S){S.element=sap.ui.getCore().byId(g(S.element));b(S.element);}function h(x,S,y){var N=S.element||sap.ui.getCore().byId(S.element.id);var A=y.getActionDataFromAggregations("createContainer",N)[0];return A;}function i(S){S.element=sap.ui.getCore().byId(g(S.element));b(S.element);S.parentId=g(S.parentId);b(S.parentId);}function j(x,S,y){var z=S.movedElements[0].element||sap.ui.getCore().byId(S.movedElements[0].id);var A=y.getAction("move",z);if(!A&&y.getMetadata().getName()==="sap.ui.dt.ElementDesignTimeMetadata"){A=y.getActionDataFromAggregations("move",x).filter(function(B){return B.aggregation===S.source.aggregation;})[0];}return A;}function k(S){S.element=sap.ui.getCore().byId(g(S.element));b(S.element);S.source.parent=sap.ui.getCore().byId(g(S.source.parent));b(S.source.parent);S.target.parent=sap.ui.getCore().byId(g(S.target.parent));b(S.target.parent);S.movedElements.forEach(function(x){x.element=sap.ui.getCore().byId(g(x.element));b(x.element);});}function l(x,S,y){var R=S.renamedElement;var A=y.getAction("rename",R);return A;}function n(S){S.element=sap.ui.getCore().byId(g(S.element));b(S.element);S.renamedElement=sap.ui.getCore().byId(g(S.renamedElement));b(S.renamedElement);}function o(x,S,y){var R=S.removedElement;if(!R){R=x;}else if(!(R instanceof M)){throw new Error("No valid 'removedElement' found");}var A=y.getAction("remove",R);return A;}function p(S){S.element=sap.ui.getCore().byId(g(S.element));b(S.element);S.removedElement=sap.ui.getCore().byId(g(S.removedElement));b(S.removedElement);}function q(x,S,y){var z=S.source;var A=y.getAction("combine",z);return A;}function r(S){S.element=sap.ui.getCore().byId(g(S.element));b(S.element);S.source=sap.ui.getCore().byId(g(S.source));b(S.source);S.combineFields.forEach(function(x){x=sap.ui.getCore().byId(g(x));b(x);});}function s(x,S,y){var z=S.source;var A=y.getAction("split",z);return A;}function t(S){S.element=sap.ui.getCore().byId(g(S.element));b(S.element);S.parentElement=sap.ui.getCore().byId(g(S.parentElement));b(S.parentElement);S.source=sap.ui.getCore().byId(g(S.source));b(S.source);}function u(x,S,y){var N=S.element;var A=y.getAction("addODataProperty",N);return A;}function v(x,S,y){var R=S.directParent;var A=y.getAction("reveal",R);return A;}var C={"composite":{clazz:'sap.ui.rta.command.CompositeCommand'},"property":{clazz:'sap.ui.rta.command.Property'},"bindProperty":{clazz:'sap.ui.rta.command.BindProperty'},"addXML":{clazz:'sap.ui.rta.command.AddXML',configure:d,adjustForBinding:f},"createContainer":{clazz:'sap.ui.rta.command.CreateContainer',configure:h,adjustForBinding:i},"move":{clazz:'sap.ui.rta.command.Move',configure:j,adjustForBinding:k},"remove":{clazz:'sap.ui.rta.command.Remove',configure:o,adjustForBinding:p},"rename":{clazz:'sap.ui.rta.command.Rename',configure:l,adjustForBinding:n},"addODataProperty":{clazz:'sap.ui.rta.command.AddODataProperty',configure:u},"reveal":{clazz:'sap.ui.rta.command.Reveal',configure:v},"combine":{clazz:'sap.ui.rta.command.Combine',configure:q,adjustForBinding:r},"split":{clazz:'sap.ui.rta.command.Split',configure:s,adjustForBinding:t},"switch":{clazz:'sap.ui.rta.command.ControlVariantSwitch'},"duplicate":{clazz:'sap.ui.rta.command.ControlVariantDuplicate'},"setTitle":{clazz:'sap.ui.rta.command.ControlVariantSetTitle'},"configure":{clazz:'sap.ui.rta.command.ControlVariantConfigure'},"settings":{clazz:'sap.ui.rta.command.Settings'},"addLibrary":{clazz:'sap.ui.rta.command.appDescriptor.AddLibrary'},"appDescriptor":{clazz:'sap.ui.rta.command.AppDescriptorCommand'}};function _(x,y,S,z,A,V){y=y[0].toLowerCase()+y.slice(1);var B=C[y];var G=A;if(!B){return Promise.reject(D.createError("CommandFactory#_getCommandFor","Command '"+y+"' doesn't exist, check typing","sap.ui.rta"));}return new Promise(function(R){var H=B.clazz;sap.ui.require([H.replace(/\./g,"/")],function(I){R(I);});}).then(function(H){var I,J,P,K,T;var L=x instanceof M;S=Object.assign({},S,{element:L?x:undefined,selector:L?null:x,name:y});if(B.configure){I=B.configure(x,S,z);}if(L){J=a.getOverlay(x);}if(I&&I.changeOnRelevantContainer){Object.assign(S,{element:J.getRelevantContainer()});x=S.element;}if(J&&x.sParentAggregationName){T=e(J,x);}if(T){if(B.adjustForBinding){B.adjustForBinding(S);}G=m(T,G);}K=new H(S);var N=true;if(B.configure){N=c(x,K,I);}P=N&&K.prepare(G,V);if(P){return K;}else{K.destroy();return undefined;}});}var w=M.extend("sap.ui.rta.command.CommandFactory",{metadata:{library:"sap.ui.rta",properties:{"flexSettings":{type:"object"}},associations:{},events:{}}});w.prototype.init=function(){this.setProperty("flexSettings",{layer:"CUSTOMER",developerMode:true});};w.prototype.setFlexSettings=function(x){this.setProperty("flexSettings",jQuery.extend(this.getFlexSettings(),x));};w.prototype.getCommandFor=function(x,y,S,z,V){return _(x,y,S,z,this.getFlexSettings(),V);};w.getCommandFor=function(x,y,S,z,A){if(!A){A={layer:"CUSTOMER",developerMode:true};}if(A.scenario||A.baseId){var L=F.buildLrepRootNamespace(A.baseId,A.scenario,A.projectId);A.rootNamespace=L;A.namespace=L+"changes/";}return _(x,y,S,z,A);};return w;},true);
