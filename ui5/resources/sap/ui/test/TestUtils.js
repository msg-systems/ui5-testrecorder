/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Core","sap/ui/thirdparty/URI","sap/base/util/UriParameters","sap/base/Log","jquery.sap.sjax"],function(C,U,a,L,q){"use strict";var r=/\/\$batch($|\?)/,j="application/json;charset=UTF-8;IEEE754Compatible=true",m={},M="\r\nContent-Type: application/http\r\n"+"Content-Transfer-Encoding: binary\r\n\r\nHTTP/1.1 ",R=new a(window.location.href).get("realOData"),b=/^(GET|DELETE|PATCH|POST) (\S+) HTTP\/1\.1$/,d={},p=R==="true"||R==="proxy",c=p||R==="direct",T,v="DataServiceVersion",V=v.toLowerCase(),s="OData-Version",f=s.toLowerCase();if(c){document.title=document.title+" (real OData)";}function g(A,e,P){var i=QUnit.objectType(A),E=QUnit.objectType(e),n;if(i!==E){throw new Error(P+": actual type "+i+" does not match expected type "+E);}if(i==="array"){if(A.length<e.length){throw new Error(P+": array length: "+A.length+" < "+e.length);}}if(i==="array"||i==="object"){for(n in e){g(A[n],e[n],P==="/"?P+n:P+"/"+n);}}else if(A!==e){throw new Error(P+": actual value "+A+" does not match expected value "+e);}}function h(A,e,i,E){try{g(A,e,"/");QUnit.assert.pushResult({result:E,actual:A,expected:e,message:i});}catch(k){QUnit.assert.pushResult({result:!E,actual:A,expected:e,message:(i||"")+" failed because of "+k.message});}}T={awaitRendering:function(){if(sap.ui.getCore().getUIDirty()){return new Promise(function(e){function i(){if(sap.ui.getCore().getUIDirty()){setTimeout(i,1);}else{e();}}i();});}},deepContains:function(A,e,i){h(A,e,i,true);},notDeepContains:function(A,e,i){h(A,e,i,false);},useFakeServer:function(S,B,F){function i(H,I,J){var K=J.requestBody,N,O=[""];N=u(K);K.split(N).slice(1,-1).forEach(function(P){var Q,W=J.requestHeaders,X,Y,Z;P=P.slice(P.indexOf("\r\n\r\n")+4);X=u(P);Q=b.exec(X);if(!Q){Z=A(X);}else if(Q[1]==="DELETE"){Z="204\r\n"+"Content-Length: 0\r\n"+n(x(W))+"\r\n\r\n";}else if(Q[1]==="POST"||Q[1]==="PATCH"){Z="200\r\nContent-Type: "+j+"\r\n"+n(x(W))+"\r\n"+y(P);}else{Y=I[H+Q[2]];if(Y){try{Z="200\r\nContent-Type: "+j+"\r\n";Object.keys(Y[1]).forEach(function($){var _=$.toLowerCase();if(_===V||_===f){return;}Z+=$+": "+Y[1][$]+"\r\n";});Z+=n(x(W,Y[1]))+"\r\n"+JSON.stringify(JSON.parse(Y[2]))+"\r\n";L.info(X,R==="logMock"?Z:null,"sap.ui.test.TestUtils");}catch(e){Z=k(X,500,"Invalid JSON");}}else{Z=A(X);}}O.push(M+Z);});O.push("--\r\n");E([200,{"Content-Type":"multipart/mixed;boundary="+N.slice(2)},O.join(N)],J);}function k(e,H,I){L.error(e,I,"sap.ui.test.TestUtils");return H+"\r\nContent-Type: text/plain\r\n\r\n"+I+"\r\n";}function l(){var H,e,I,J,K,N={};for(K in F){I=F[K];H=I.headers||{};J=I.responseHeaders||{};if(I.source){e=D(B+I.source);H["Content-Type"]=H["Content-Type"]||o(I.source);}else{e=I.message||"";}N[K]=[I.code||200,H,e,J];}return N;}function n(H){return H&&H.length?H.join(": ")+"\r\n":"";}function o(N){if(/\.xml$/.test(N)){return"application/xml";}if(/\.json$/.test(N)){return j;}return"application/x-octet-stream";}function t(e){E([200,{"Content-Type":j},e.requestBody],e);}function u(e){return e.slice(0,e.indexOf("\r\n"));}function w(H,K){var e;K=K.toLowerCase();for(e in H){if(e.toLowerCase()===K){return H[e];}}}function x(e,H){var O=w(H,s),I=w(H,v),J=[];if(!O&&!I){O=w(e,s);I=w(e,v);}if(O){J.push(s);J.push(O);}else if(I){J.push(v);J.push(I);}return J;}function y(e){return e.slice(e.indexOf("\n\r\n")+3);}function z(e,H){var I=H.url;if(r.test(I)){i(I.slice(0,I.indexOf("/$batch")+1),e,H);}else{t(H);}}function A(e){return k(e,404,"No mock data found");}function D(P){var e=m[P],H;if(!e){H=q.sap.sjax({url:P,dataType:"text"});if(!H.success){throw new Error(P+": resource not found");}m[P]=e=H.data;}return e;}function E(e,H){var I=e[1],J=x({},I);if(J.length===0){J=x(H.requestHeaders);if(J.length>0){I=q.extend({},I);I[J[0]]=J[1];}}H.respond(e[0],I,e[2]);}function G(){var e,H,I=l(),J;H=sinon.fakeServer.create();S.add(H);H.autoRespond=true;for(J in I){H.respondWith("GET",J,E.bind(null,I[J]));}H.respondWith("DELETE",/.*/,E.bind(null,[204,{},""]));H.respondWith("HEAD",/.*/,E.bind(null,[200,{},""]));H.respondWith("PATCH",/.*/,t);H.respondWith("POST",/.*/,z.bind(null,I));e=H.restore;H.restore=function(){sinon.FakeXMLHttpRequest.filters=[];e.apply(this,arguments);};sinon.xhr.supportsCORS=q.support.cors;sinon.FakeXMLHttpRequest.useFilters=true;sinon.FakeXMLHttpRequest.addFilter(function(K,J){return K!=="DELETE"&&K!=="HEAD"&&K!=="PATCH"&&K!=="POST"&&!(K==="GET"&&J in I);});}B=sap.ui.require.toUrl(B).replace(/(^|\/)resources\/(~[-a-zA-Z0-9_.]*~\/)?/,"$1test-resources/")+"/";G();},withNormalizedMessages:function(e){var S=sinon.sandbox.create();try{var o=sap.ui.getCore(),G=o.getLibraryResourceBundle;S.stub(o,"getLibraryResourceBundle").returns({getText:function(k,A){var l=k,t=G.call(o).getText(k),i;for(i=0;i<10;i+=1){if(t.indexOf("{"+i+"}")>=0){l+=" "+(i>=A.length?"{"+i+"}":A[i]);}}return l;}});e.apply(this);}finally{S.verifyAndRestore();}},isRealOData:function(){return c;},getRealOData:function(){return R?"&realOData="+R:"";},getBaseUri:function(){var e;if(document.baseURI){return document.baseURI;}e=document.getElementsByTagName("base");return e[0]&&e[0].href||location.href;},proxy:function(A){var P;if(!p){return A;}P=sap.ui.require.toUrl("sap/ui").replace("resources/sap/ui","proxy");return new U(P+A,T.getBaseUri()).pathname().toString();},retrieveData:function(k){var e=d[k];delete d[k];return e;},setData:function(k,e){d[k]=e;},setupODataV4Server:function(S,F,e,i){var k={};if(c){return;}if(!i){i="/";}else if(i.slice(-1)!=="/"){i+="/";}Object.keys(F).forEach(function(u){var A=u[0]==="/"?u:i+u;k[A]=F[u];});T.useFakeServer(S,e||"sap/ui/core/qunit/odata/v4/data",k);}};return T;},true);
