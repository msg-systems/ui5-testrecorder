/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/SyncPromise","sap/base/Log","./_AggregationHelper","./_Cache","./_Helper","./_Parser","sap/ui/thirdparty/jquery"],function(S,L,_,a,b,c,q){"use strict";var r=/,|%2C|%2c/,d=new RegExp("^"+c.sODataIdentifier+"(?:"+c.sWhitespace+"+(?:asc|desc))?$"),e=new RegExp(c.sWhitespace+"+");function f(R,s,A,Q,g){var m={},F,h,M;a.call(this,R,s,Q,g);if(_.hasMinOrMax(A.aggregate)){if(A.groupLevels.length){throw new Error("Unsupported group levels together with min/max");}this.oMeasureRangePromise=new Promise(function(i,j){M=i;});h=_.buildApply(A,Q,m);Q=q.extend({},Q);delete Q.$count;this.oFirstLevel=a.create(R,s,h,g);this.oFirstLevel.getResourcePath=f.getResourcePath.bind(this.oFirstLevel,A,Q,this.oFirstLevel.getResourcePath);this.oFirstLevel.handleResponse=f.handleResponse.bind(this.oFirstLevel,m,M,this.oFirstLevel.handleResponse);}else{if(Q.$count){throw new Error("Unsupported system query option: $count");}if(Q.$filter){throw new Error("Unsupported system query option: $filter");}F=f.filterAggregationForFirstLevel(A);h=q.extend({},Q,{$count:true,$orderby:f.filterOrderby(Q.$orderby,F)});this.oFirstLevel=a.create(R,s,_.buildApply(F,h),g);this.oFirstLevel.calculateKeyPredicate=f.calculateKeyPredicate.bind(null,F,this.oFirstLevel.sMetaPath,this.oFirstLevel.aElements.$byPredicate);}}f.prototype=Object.create(a.prototype);f.prototype.fetchValue=function(g,p,D,l){if(!this.oMeasureRangePromise&&p==="$count"){L.error("Failed to drill-down into $count, invalid segment: $count",this.oFirstLevel.toString(),"sap.ui.model.odata.v4.lib._Cache");return S.resolve();}return this.oFirstLevel.fetchValue(g,p,D,l);};f.prototype.getMeasureRangePromise=function(){return this.oMeasureRangePromise;};f.prototype.read=function(i,l,p,g,D){var R=this.oFirstLevel.read(i,l,p,g,D);if(!this.oMeasureRangePromise){return R.then(function(o){o.value.forEach(function(E){E["@$ui5.node.isExpanded"]=false;E["@$ui5.node.isTotal"]=true;E["@$ui5.node.level"]=1;});return o;});}return R;};f.calculateKeyPredicate=function(A,m,B,g,t){var F=A.groupLevels[0],l=b.formatLiteral(g[F],t[m][F].$Type),p="("+encodeURIComponent(F)+"="+encodeURIComponent(l)+")";function s(o){return JSON.stringify(b.publicClone(o));}if(p in B){throw new Error("Multi-unit situation detected: "+s(g)+" vs. "+s(B[p]));}b.setPrivateAnnotation(g,"predicate",p);};f.create=function(R,s,A,Q,g){return new f(R,s,A,Q,g);};f.filterAggregationForFirstLevel=function(A){function g(t,k){t[k]=this[k];return t;}function h(m,F){return Object.keys(m).filter(F).reduce(g.bind(m),{});}function i(s){return A.aggregate[s].subtotals;}function j(G){return A.groupLevels.indexOf(G)>=0;}return{aggregate:h(A.aggregate,i),group:h(A.group,j),groupLevels:A.groupLevels};};f.filterOrderby=function(o,A){if(o){return o.split(r).filter(function(O){var n;if(d.test(O)){n=O.split(e)[0];return n in A.aggregate||n in A.group||A.groupLevels.indexOf(n)>=0;}return true;}).join(",");}};f.getResourcePath=function(A,Q,g,s,E){var o,R;if(s!==0){throw new Error("First request needs to start at index 0");}R=g.call(this,s,E+1);o=b.clone(A);Object.keys(o.aggregate).forEach(function(h){var D=o.aggregate[h];delete D.min;delete D.max;});this.mQueryOptions=_.buildApply(o,Q);this.sQueryString=this.oRequestor.buildQueryString(this.sMetaPath,this.mQueryOptions,false,this.bSortExpandSelect);this.getResourcePath=g;return R;};f.handleResponse=function(A,m,h,s,E,R,t){var g,M={},o;function i(j){M[j]=M[j]||{};return M[j];}if("@odata.count"in R){R["@odata.count"]-=1;}o=R.value.splice(0,1)[0];for(g in A){i(A[g].measure)[A[g].method]=o[g];}m(M);this.handleResponse=h;this.handleResponse(s,E,R,t);};return f;},false);
