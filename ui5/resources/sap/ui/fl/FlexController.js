/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/fl/Persistence","sap/ui/fl/registry/ChangeRegistry","sap/ui/fl/Utils","sap/ui/fl/LrepConnector","sap/ui/fl/Change","sap/ui/fl/Variant","sap/ui/fl/Cache","sap/ui/fl/registry/Settings","sap/ui/fl/ChangePersistenceFactory","sap/ui/core/mvc/View","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/util/reflection/XmlTreeModifier","sap/ui/core/Component","sap/ui/fl/context/ContextManager","sap/ui/core/Element","sap/base/strings/formatMessage","sap/base/Log"],function(q,P,C,U,L,a,V,b,F,c,d,J,X,e,f,E,g,h){"use strict";var l=function(s,A){this._oChangePersistence=undefined;this._sComponentName=s||"";this._sAppVersion=A||U.DEFAULT_APP_VERSION;if(this._sComponentName&&this._sAppVersion){this._createChangePersistence();}};l.appliedChangesCustomDataKey="sap.ui.fl.appliedChanges";l.failedChangesCustomDataKeyJs="sap.ui.fl.failedChanges.js";l.failedChangesCustomDataKeyXml="sap.ui.fl.failedChanges.xml";l.PENDING="sap.ui.fl:PendingChange";l.PROCESSING="sap.ui.fl:ProcessingChange";l.variantTechnicalParameterName="sap-ui-fl-control-variant-id";l.prototype.setComponentName=function(s){this._sComponentName=s;this._createChangePersistence();};l.prototype.getComponentName=function(){return this._sComponentName;};l.prototype.getAppVersion=function(){return this._sAppVersion;};l.prototype.getVariantModelData=function(){var D;if(this._oChangePersistence&&this._oChangePersistence._oVariantController._mVariantManagement&&Object.keys(this._oChangePersistence._oVariantController._mVariantManagement).length>0){D=this._oChangePersistence._oVariantController._fillVariantModel();}return D;};l.prototype.createBaseChange=function(o,i){var j,k;var m=f._getContextIdsFromUrl();if(m.length>1){throw new Error("More than one DesignTime Context is currently active.");}if(!i){throw new Error("No Component found - to offer flexibility. Valid relation to its owning component must be present.");}o.reference=this.getComponentName();o.packageName="$TMP";o.context=m.length===1?m[0]:"";o.validAppVersions=this._getValidAppVersions(o);j=a.createInitialFileContent(o);k=new a(j);if(o.variantReference){k.setVariantReference(o.variantReference);}return k;};l.prototype.createChange=function(o,i){var j,k;if(!i){throw new Error("A flexibility change cannot be created without a targeted control.");}var s=i.id||i.getId();if(!o.selector){o.selector={};}var m=i.appComponent||U.getSelectorComponentForControl(i);if(!m){throw new Error("No Component found - to offer flexibility the control with the id '"+s+"' has to have a valid relation to its owning application component.");}if(U.hasLocalIdSuffix(s,m)){var n=m.getLocalId(s);if(!n){throw new Error("Generated ID attribute found ('"+s+"'); provide a stable ID for the control as required by flexibility for assigning the changes.");}o.selector.id=n;o.selector.idIsLocal=true;}else{o.selector.id=s;o.selector.idIsLocal=false;}j=this.createBaseChange(o,m);var p=i.controlType||U.getControlType(i);if(!p){throw new Error("No control type found - the change handler can not be retrieved.");}k=this._getChangeHandler(j,p,i,J);if(k){k.completeChangeContent(j,o,{modifier:J,appComponent:m});}else{throw new Error("Change handler could not be retrieved for change "+JSON.stringify(o)+".");}return j;};l.prototype.createVariant=function(v,A){var o,i;if(!A){throw new Error("No Application Component found - to offer flexibility the variant has to have a valid relation to its owning application component.");}v.content.reference=this.getComponentName();v.content.packageName="$TMP";v.content.validAppVersions=this._getValidAppVersions(v);i=V.createInitialFileContent(v);o=new V(i);return o;};l.prototype._getValidAppVersions=function(o){var A=this.getAppVersion();var v={creation:A,from:A};if(A&&o.developerMode&&o.scenario!==sap.ui.fl.Scenario.AdaptationProject&&o.scenario!==sap.ui.fl.Scenario.AppVariant){v.to=A;}return v;};l.prototype.addChange=function(o,i){var j=this.createChange(o,i);var k=U.getSelectorComponentForControl(i);this.addPreparedChange(j,k);return j;};l.prototype.addPreparedChange=function(o,i){if(o.getVariantReference()){var A=U.getAppComponentForControl(i);var m=A.getModel("$FlexVariants");m._addChange(o);}this._oChangePersistence.addChange(o,i);return o;};l.prototype.deleteChange=function(o,i){var A=U.getAppComponentForControl(i);this._oChangePersistence.deleteChange(o);if(o.getVariantReference()){A.getModel("$FlexVariants")._removeChange(o);}};l.prototype.createAndApplyChange=function(o,i){var j=this.addChange(o,i);var p={modifier:J,component:U.getSelectorComponentForControl(i),view:U.getViewForControl(i)};return this.checkTargetAndApplyChange(j,i,p).then(function(r){if(!r.success){var k=r.error||new Error("The change could not be applied.");this._oChangePersistence.deleteChange(j);throw k;}}.bind(this));};l.prototype._checkDependencies=function(o,D,m,j,r){var R=this._checkChange(o,j);if(!R){return[];}r.push(o);var s=o.getId();var k=D[s]&&D[s].dependencies||[];for(var i=0,n=k.length;i<n;i++){var p=U.getChangeFromChangesMap(m,k[i]);R=this._checkDependencies(p,D,m,j,r);if(R.length===0){r=[];break;}delete D[s];}return r;};l.prototype._checkChange=function(o,A){var s;var S=o.getSelector();if(S.idIsLocal){s=A.createId(S.id);}else{s=S.id;}var i=sap.ui.getCore().byId(s);if(!i){return false;}var j=this._getFailedCustomDataJs(o,i,J).customDataEntries;if(j.indexOf(o.getId())>-1){return false;}return true;};l.prototype.waitForChangesToBeApplied=function(o){var m=this._oChangePersistence.getChangesMapForComponent();var p=[];var D=Object.assign({},m.mDependencies);var i=m.mChanges;var j=i[o.getId()]||[];var A=this._getAppliedCustomData(undefined,o,J).customDataEntries;var k=U.getSelectorComponentForControl(o);var n=j.filter(function(s){return A.indexOf(s.getId())===-1;});var r=[];n.forEach(function(s){var t=this._checkDependencies(s,D,m.mChanges,k,[]);r=r.concat(t);},this);r=r.filter(function(s,t,u){return u.indexOf(s)===t;});r.forEach(function(w){if(!w.aPromiseFn){w.aPromiseFn=[];}p.push(new Promise(function(s,t){w.aPromiseFn.push({resolve:s,reject:t});}).catch(function(s){var t=s.getId&&m.mDependentChangesOnMe[s.getId()]||[];t.forEach(function(u){var v=U.getChangeFromChangesMap(i,u);if(v.aPromiseFn){v.aPromiseFn.forEach(function(x){x.reject(v);});}});Promise.resolve();}));},this);return Promise.all(p);};l.prototype.saveAll=function(s){return this._oChangePersistence.saveDirtyChanges(s);};l.prototype.processXmlView=function(v,p){var o=e.get(p.componentId);var m=U.getAppComponentForControl(o).getManifest();p.component=o;p.appDescriptor=m;p.modifier=X;p.view=v;return this.processViewByModifier(p);};l.prototype.processViewByModifier=function(p){p.siteId=U.getSiteId(p.component);return this._oChangePersistence.getChangesForView(p.viewId,p).then(this._resolveGetChangesForView.bind(this,p),this._handlePromiseChainError.bind(this,p.view));};l.prototype._checkForDependentSelectorControls=function(o,p){var D=o.getDependentControlSelectorList(p.component);D.forEach(function(s){var i=p.modifier.bySelector(s,p.component,p.view);if(!i){throw new Error("A dependent selector control of the flexibility change is not available.");}});};l.prototype._resolveGetChangesForView=function(p,i){var j=[];if(!Array.isArray(i)){var s="No list of changes was passed for processing the flexibility on view: "+p.view+".";U.log.error(s,undefined,"sap.ui.fl.FlexController");return[];}i.forEach(function(o){try{var S=this._getSelectorOfChange(o);if(!S||!S.id){throw new Error("No selector in change found or no selector ID.");}var k=p.modifier.bySelector(S,p.component,p.view);if(!k){throw new Error("A flexibility change tries to change a nonexistent control.");}this._checkForDependentSelectorControls(o,p);j.push(function(){return this.checkTargetAndApplyChange(o,k,p).then(function(r){if(!r.success){this._logApplyChangeError(r.error||{},o);}}.bind(this));}.bind(this));}catch(m){this._logApplyChangeError(m,o);}}.bind(this));return U.execPromiseQueueSequentially(j).then(function(){return p.view;});};l.prototype._logApplyChangeError=function(o,i){var D=i.getDefinition();var s=D.changeType;var t=D.selector.id;var j=D.namespace+D.fileName+"."+D.fileType;var w="A flexibility change could not be applied.";w+="\nThe displayed UI might not be displayed as intedend.";if(o.message){w+="\n   occurred error message: '"+o.message+"'";}w+="\n   type of change: '"+s+"'";w+="\n   LRep location of the change: "+j;w+="\n   id of targeted control: '"+t+"'.";U.log.warning(w,undefined,"sap.ui.fl.FlexController");};l.prototype.checkTargetAndApplyChange=function(o,i,p){var x=p.modifier.targets==="xmlTree";var m=p.modifier;var s=m.getControlType(i);var j=this._getControlIfTemplateAffected(o,i,s,p);var k=this._getChangeHandler(o,j.controlType,j.control,m);var S;var r;p.appComponent=p.component||p.appComponent;delete p.component;if(!k){var n="Change handler implementation for change not found or change type not enabled for current layer - Change ignored";U.log.warning(n);return new U.FakePromise({success:false,error:new Error(n)});}if(x&&o.getDefinition().jsOnly){return new U.FakePromise({success:false,error:new Error("Change can not be applied in XML. Retrying in JS.")});}var A=this._getAppliedCustomData(o,i,m);var t=A.customDataValue;var u=A.customData;if(!this._isChangeCurrentlyApplied(i,o,m,A)){var R=this.isChangeHandlerRevertible(o,j.control,k);return new U.FakePromise().then(function(){S=F.getInstanceOrUndef();if(!R&&S&&S._oSettings.recordUndo){if(x){throw new Error();}return new Promise(function(v){sap.ui.require(["sap/ui/rta/ControlTreeModifier"],function(w){if(!w){U.log.error("Please load 'sap/ui/rta' library if you want to record undo");}else{p.modifier=w;w.startRecordingUndo();r=w;}v();});});}}).then(function(){o.PROCESSING=o.PROCESSING?o.PROCESSING:true;var I=k.applyChange(o,j.control,p);if(j.bTemplateAffected){m.updateAggregation(i,o.getContent().boundAggregation);}return I;}).then(function(I){if(I instanceof E){i=I;A=this._getAppliedCustomData(o,i,m);t=A.customDataValue;u=A.customData;}if(!R&&S&&S._oSettings.recordUndo&&r){o.setUndoOperations(r.stopRecordingUndo());}var v=o.getId();var w=t?t+","+v:v;this._writeAppliedChangesCustomData(u,w,p,i);if(o.aPromiseFn){o.aPromiseFn.forEach(function(y){y.resolve(o);});}delete o.PROCESSING;o.PROCESSED=true;return{success:true};}.bind(this)).catch(function(v){var w;this._setMergeError(true);var y="Change ''{0}'' could not be applied. Merge error detected while "+"processing the {1}.";if(x){w=this._getFailedCustomDataXml(o,i,m);y=g(y,[o.getId(),"XML tree"]);h.warning(y,v.stack||"");}else{w=this._getFailedCustomDataJs(o,i,m);y=g(y,[o.getId(),"JS control tree"]);h.error(y,v.stack||"");}var z=w.customData;w.customDataEntries.push(o.getId());var B=w.customDataEntries.join(",");if(x){this._writeFailedChangesCustomDataXml(z,B,p,i);}else{this._writeFailedChangesCustomDataJs(z,B,p,i);}if(o.aPromiseFn){o.aPromiseFn.forEach(function(D){D.reject(o);});}delete o.PROCESSING;o.PROCESSED=true;return{success:false,error:v};}.bind(this));}return new U.FakePromise({success:true});};l.prototype._removeFromAppliedChangesAndMaybeRevert=function(o,i,p,r){var A,j,I;var m=p.modifier;var s=m.getControlType(i);var k=this._getControlIfTemplateAffected(o,i,s,p);var n=this._getChangeHandler(o,k.controlType,k.control,m);var R;p.appComponent=p.component||p.appComponent;delete p.component;if(r&&!n){U.log.warning("Change handler implementation for change not found or change type not enabled for current layer - Change ignored");return new U.FakePromise();}var t=o.getId();var u=this._getAppliedCustomData(o,i,m);A=u.customDataEntries;j=u.customData;I=A.indexOf(t);if(I===-1&&(o.PROCESSING||o.QUEUED)){R=new Promise(function(v,w){o.aPromiseFn=o.aPromiseFn||[];o.aPromiseFn.push({resolve:v,reject:w});}).then(function(v){return true;});}else{R=new U.FakePromise(false);}return R.then(function(v){if(r&&(v||(!v&&I>-1))){var w=n.revertChange(o,k.control,p);if(k.bTemplateAffected){m.updateAggregation(i,o.getContent().boundAggregation);}return w;}}).then(function(){u=this._getAppliedCustomData(o,i,m);A=u.customDataEntries;j=u.customData;I=A.indexOf(t);if(I>-1&&j){A.splice(I,1);this._writeAppliedChangesCustomData(j,A.join(),p,i);}}.bind(this)).catch(function(v){U.log.error("Change could not be reverted:",v);});};l.prototype._writeAppliedChangesCustomData=function(o,v,p,i){this._writeCustomData(o,v,p,i,l.appliedChangesCustomDataKey);};l.prototype._writeFailedChangesCustomDataXml=function(o,v,p,i){this._writeCustomData(o,v,p,i,l.failedChangesCustomDataKeyXml);};l.prototype._writeFailedChangesCustomDataJs=function(o,v,p,i){this._writeCustomData(o,v,p,i,l.failedChangesCustomDataKeyJs);};l.prototype._writeCustomData=function(o,v,p,i,s){var m=p.modifier;if(o){m.setProperty(o,"value",v);}else{var O=p.appComponent;var j=p.view;o=m.createControl("sap.ui.core.CustomData",O,j);m.setProperty(o,"key",s);m.setProperty(o,"value",v);m.insertAggregation(i,"customData",o,0,j);}};l.prototype._getAppliedCustomData=function(o,i,m){return this._getCustomData(o,i,m,l.appliedChangesCustomDataKey);};l.prototype._getFailedCustomDataXml=function(o,i,m){return this._getCustomData(o,i,m,l.failedChangesCustomDataKeyXml);};l.prototype._getFailedCustomDataJs=function(o,i,m){return this._getCustomData(o,i,m,l.failedChangesCustomDataKeyJs);};l.prototype._getCustomData=function(o,i,m,s){var j=m.getAggregation(i,"customData")||[];var r={customDataEntries:[]};j.some(function(k){var K=m.getProperty(k,"key");if(K===s){r.customData=k;r.customDataValue=m.getProperty(k,"value");r.customDataEntries=r.customDataValue.split(",");return true;}});return r;};l.prototype._handlePromiseChainError=function(v,o){U.log.error("Error processing view "+o+".");return v;};l.prototype._getSelectorOfChange=function(o){if(!o||!o.getSelector){return undefined;}return o.getSelector();};l.prototype._getChangeHandler=function(o,s,i,m){var j=o.getChangeType();var k=o.getLayer();return this._getChangeRegistry().getChangeHandler(j,s,i,m,k);};l.prototype._getChangeRegistry=function(){var i=C.getInstance();i.initSettings();return i;};l.prototype._getControlIfTemplateAffected=function(o,i,s,p){var j=o.getDefinition();var m={};if(o.getContent().boundAggregation&&j.dependentSelector.originalSelector){var M=p.modifier;m.control=M.bySelector(j.dependentSelector.originalSelector,p.component,p.view);m.controlType=M.getControlType(m.control);m.bTemplateAffected=true;}else{m.control=i;m.controlType=s;m.bTemplateAffected=false;}return m;};l.prototype.getComponentChanges=function(p,i){return this._oChangePersistence.getChangesForComponent(p,i);};l.prototype.checkForOpenDependenciesForControl=function(s,m,o){return this._oChangePersistence.checkForOpenDependenciesForControl(s,m,o);};l.prototype.isPersonalized=function(p){p=p||{};p.includeVariants=true;return this.getComponentChanges(p).then(function(v){var i=v==="userLevelVariantChangesExist"||v.some(function(o){return o.isUserDependent();});return!!i;});};l.prototype._createChangePersistence=function(){this._oChangePersistence=c.getChangePersistenceForComponent(this.getComponentName(),this.getAppVersion());return this._oChangePersistence;};l.prototype.resetChanges=function(s,G,o){return this._oChangePersistence.resetChanges(s,G).then(function(r){if(o){var m=o.getModel("$FlexVariants");if(m){m.updateHasherEntry({parameters:[],updateURL:true,component:o});}}return r;});};l.prototype.discardChanges=function(i,D){var A=U.getCurrentLayer(!!D);var I=0;var j;var o;j=i.length;while(I<i.length){o=i[I];if(o&&o.getLayer&&o.getLayer()===A){this._oChangePersistence.deleteChange(o);}if(j===i.length){I++;}else{j=i.length;}}return this._oChangePersistence.saveDirtyChanges();};l.prototype.discardChangesForId=function(i,D){if(!i){return Promise.resolve();}var o=this._oChangePersistence.getChangesMapForComponent();var j=o.mChanges[i]||[];return this.discardChanges(j,D);};l.prototype._setMergeError=function(){return F.getInstance().then(function(s){s.setMergeErrorOccured(true);});};l.prototype._isChangeCurrentlyApplied=function(o,i,m,j){if(!j){j=this._getAppliedCustomData(i,o,J);}var A=j.customDataEntries;var s=i.getId();return A.indexOf(s)>-1;};l.prototype._checkIfDependencyIsStillValid=function(A,m,s){var o=U.getChangeFromChangesMap(this._oChangePersistence._mChanges.mChanges,s);if(!o.PROCESSED){return true;}var i=m.bySelector(o.getSelector(),A);if(!this._isChangeCurrentlyApplied(i,o,m)){return true;}return false;};l.prototype._applyChangesOnControl=function(G,o,i){var p=[];var m=G();var j=m.mChanges;var D=m.mDependencies;var k=m.mDependentChangesOnMe;var n=j[i.getId()]||[];var r={modifier:J,component:o,view:U.getViewForControl(i)};n.forEach(function(s){if(s.PROCESSED&&!this._isChangeCurrentlyApplied(i,s,r.modifier)){m=this._oChangePersistence.copyDependenciesFromInitialChangesMap(s,this._checkIfDependencyIsStillValid.bind(this,o,r.modifier));D=m.mDependencies;k=m.mDependentChangesOnMe;delete s.PROCESSED;}if(!D[s.getId()]){s.QUEUED=true;p.push(function(){return this.checkTargetAndApplyChange(s,i,r).then(function(R){if(R.success){this._updateDependencies(D,k,s.getId());}delete s.QUEUED;}.bind(this));}.bind(this));}else{D[s.getId()][l.PENDING]=this.checkTargetAndApplyChange.bind(this,s,i,r);}}.bind(this));return U.execPromiseQueueSequentially(p).then(function(){return this._processDependentQueue(D,k,o);}.bind(this));};l.prototype.getBoundApplyChangesOnControl=function(G,o){var B=this._applyChangesOnControl.bind(this,G,o);B._bIsSapUiFlFlexControllerApplyChangesOnControl=true;return B;};l.prototype.revertChangesOnControl=function(i,o){var p=[];i.forEach(function(j){p.push(function(){var s=this._getSelectorOfChange(j);var k=J.bySelector(s,o);var m={modifier:J,component:o,view:U.getViewForControl(k)};return this._removeFromAppliedChangesAndMaybeRevert(j,k,m,true).then(function(){this._oChangePersistence._deleteChangeInMap(j);}.bind(this));}.bind(this));}.bind(this));return U.execPromiseQueueSequentially(p);};l.prototype.isChangeHandlerRevertible=function(o,i,j){if(!j){var s=J.getControlType(i);j=this._getChangeHandler(o,s,i,J);}return!!(j&&typeof j.revertChange==="function");};l.prototype.applyVariantChanges=function(i,o){var o=U.getSelectorComponentForControl(o);var p=[];i.forEach(function(j){var m=this._oChangePersistence.getChangesMapForComponent().mChanges;var A=Object.keys(m).reduce(function(i,s){return i.concat(m[s]);},[]);this._oChangePersistence._addChangeAndUpdateDependencies(o,j,A.length,A);p.push(function(){var M=J;var s=this._getSelectorOfChange(j);var k=M.bySelector(s,o);if(!k){U.log.error("A flexibility change tries to change a nonexistent control.");return new U.FakePromise();}return this._applyChangesOnControl(this._oChangePersistence.getChangesMapForComponent.bind(this._oChangePersistence),o,k);}.bind(this));}.bind(this));return U.execPromiseQueueSequentially(p);};l.prototype.removeFromAppliedChangesOnControl=function(o,i,j){var p={modifier:J,component:i,view:U.getViewForControl(j)};return this._removeFromAppliedChangesAndMaybeRevert(o,j,p,false);};l.prototype._updateControlsDependencies=function(D,A){var o;Object.keys(D).forEach(function(s){var i=D[s];if(i.controlsDependencies&&i.controlsDependencies.length>0){var j=i.controlsDependencies.length;while(j--){var S=i.controlsDependencies[j];o=J.bySelector(S,A);if(o){i.controlsDependencies.splice(j,1);}}}});};l.prototype._updateDependencies=function(D,m,s){if(m[s]){m[s].forEach(function(k){var o=D[k];var i=o.dependencies.indexOf(s);if(i>-1){o.dependencies.splice(i,1);}});delete m[s];}};l.prototype._iterateDependentQueue=function(D,m,A){var i=[],n=[],p=[];this._updateControlsDependencies(D,A);Object.keys(D).forEach(function(s){var o=D[s];if(o[l.PENDING]&&o.dependencies.length===0&&!(o.controlsDependencies&&o.controlsDependencies.length>0)&&!o[l.PROCESSING]){o[l.PROCESSING]=true;p.push(function(){return o[l.PENDING]().then(function(r){if(r.success){n.push(s);i.push(o.changeObject.getId());}});});}});return U.execPromiseQueueSequentially(p).then(function(){for(var j=0;j<n.length;j++){delete D[n[j]];}for(var k=0;k<i.length;k++){this._updateDependencies(D,m,i[k]);}return i;}.bind(this));};l.prototype._processDependentQueue=function(D,m,o){return this._iterateDependentQueue(D,m,o).then(function(A){if(A.length>0){return this._processDependentQueue(D,m,o);}}.bind(this));};return l;},true);
