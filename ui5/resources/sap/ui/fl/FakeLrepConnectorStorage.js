/*
 * ! UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/FakeLrepConnector","sap/ui/fl/LrepConnector","sap/ui/fl/Cache","sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/Utils"],function(F,L,C,a,U){"use strict";return function(f){b._oBackendInstances={};function b(s){this.mSettings=Object.assign({"isKeyUser":true,"isAtoAvailable":false,"isProductiveSystem":false},s);}Object.assign(b.prototype,F.prototype);b.prototype.create=function(c){var r;if(Array.isArray(c)){r=c.map(function(m){return this._saveChange(m);}.bind(this));}else{r=this._saveChange(c);}return Promise.resolve({response:r,status:'success'});};b.prototype._saveChange=function(c){if(!c.creation){c.creation=new Date().toISOString();}f.saveChange(c.fileName,c);return c;};b.prototype.update=function(c,s,d,i){return Promise.resolve({response:this._saveChange(c),status:'success'});};b.prototype.send=function(u,m,d,o){if(m==="DELETE"){return F.prototype.send.apply(this,arguments).then(function(r){f.getChanges().forEach(function(c){if(c.reference===r.response.parameters[1]&&c.layer===r.response.parameters[2]){f.deleteChange(c.fileName);}});return Promise.resolve({response:undefined,status:"nocontent"});});}else{return F.prototype.send.apply(this,arguments);}};b.prototype.deleteChange=function(c){f.deleteChange(c.sChangeName);return Promise.resolve({response:undefined,status:"nocontent"});};b.prototype.deleteChanges=function(){f.deleteChanges();return Promise.resolve({response:undefined,status:"nocontent"});};b.prototype.loadChanges=function(c){var d=f.getChanges();return new Promise(function(r,e){var R={};if(this.mSettings.sInitialComponentJsonPath){jQuery.getJSON(this.mSettings.sInitialComponentJsonPath).done(function(o){R={changes:o,componentClassName:c};r(R);}).fail(function(g){e(g);});}else{r(R);}}.bind(this)).then(function(r){var v=[];var e=[];var g=[];var h=[];d.forEach(function(o){if(o.fileType==="ctrl_variant"&&o.variantManagementReference){v.push(o);}else if(o.fileType==="ctrl_variant_change"){e.push(o);}else if(o.fileType==="ctrl_variant_management_change"){g.push(o);}else{h.push(o);}});r=this._createChangesMap(r,v);r=this._sortChanges(r,h,e,g);r=this._assignVariantReferenceChanges(r);r.changes.contexts=[];r.changes.settings=this.mSettings;r.componentClassName=c;return r;}.bind(this));};b.prototype._createChangesMap=function(r,v){if(!r||!r.changes){r={changes:{}};}if(!r.changes.changes){r.changes.changes=[];}if(!r.changes.variantSection){r.changes.variantSection={};}var c=function(e,n){return e.some(function(o){return o.content.fileName===n.fileName;});};var V={};v.forEach(function(o){V=r.changes.variantSection[o.variantManagementReference];if(!V){var s=this._fakeStandardVariant(o.variantManagementReference);V=this._getVariantManagementStructure([this._getVariantStructure(s,[],{}),this._getVariantStructure(o,[],{})],{});r.changes.variantSection[o.variantManagementReference]=V;}else if(!c(V.variants,o)){V.variants.push(this._getVariantStructure(o,[],{}));}}.bind(this));return r;};b.prototype._getVariantStructure=function(v,c,V){return{content:v,controlChanges:c,variantChanges:V};};b.prototype._getVariantManagementStructure=function(v,V){return{variants:v,variantManagementChanges:V};};b.prototype._assignVariantReferenceChanges=function(r){Object.keys(r.changes.variantSection).forEach(function(v){var V=r.changes.variantSection[v].variants;V.forEach(function(o){var s=o.content.variantReference;var e=o.controlChanges;if(s){e=this._getReferencedChanges(r,o).concat(e);}o.controlChanges=e;}.bind(this));}.bind(this));return r;};b.prototype._getReferencedChanges=function(r,c){var R=[];r.changes.variantSection[c.content.variantManagementReference].variants.some(function(v){if(c.content.variantReference===v.content.fileName){R=v.controlChanges.filter(function(o){return U.isLayerAboveCurrentLayer(o.layer)===-1;});if(v.content.variantReference){R=R.concat(this._getReferencedChanges(r,v));}return true;}}.bind(this));return R;};b.prototype._sortChanges=function(r,c,d,e){var A=function(r,V,o){r.changes.variantSection[V].variants.some(function(h){if(h.content.fileName===o.variantReference){h.controlChanges.push(o);return true;}});};var g=function(r,V,o){r.changes.variantSection[V].variants.some(function(h){if(h.content.fileName===o.selector.id){if(!h.variantChanges[o.changeType]){h.variantChanges[o.changeType]=[];}h.variantChanges[o.changeType].push(o);return true;}});};var v={};e.forEach(function(V){var s=V.selector.id;if(Object.keys(r.changes.variantSection).length===0){r.changes.variantSection[s]=this._getVariantManagementStructure([this._getVariantStructure(this._fakeStandardVariant(s),[],{})],{});}v=r.changes.variantSection[s].variantManagementChanges;if(!v[V.changeType]){v[V.changeType]=[];}v[V.changeType].push(V);}.bind(this));c.forEach(function(o){if(!o.variantReference){r.changes.changes.push(o);}else if(Object.keys(r.changes.variantSection).length===0){r.changes.variantSection[o.variantReference]=this._getVariantManagementStructure([this._getVariantStructure(this._fakeStandardVariant(o.variantReference),[o],{})],{});}else{Object.keys(r.changes.variantSection).forEach(function(V){A(r,V,o);});}}.bind(this));d.forEach(function(V){if(Object.keys(r.changes.variantSection).length===0){var m={};m[V.changeType]=[V];r.changes.variantSection[V.selector.id]=this._getVariantManagementStructure([this._getVariantStructure(this._fakeStandardVariant(V.selector.id),[],m)],{});}else{Object.keys(r.changes.variantSection).forEach(function(s){g(r,s,V);});}}.bind(this));r.changes.changes=this._sortNonVariantChangesByLayer(r.changes.changes);return r;};b.prototype._fakeStandardVariant=function(v){return{fileName:v,fileType:"ctrl_variant",variantManagementReference:v,variantReference:"",content:{title:sap.ui.getCore().getLibraryResourceBundle("sap.ui.fl").getText("STANDARD_VARIANT_TITLE")}};};b.prototype._sortNonVariantChangesByLayer=function(c){if(!c||c.length===0){return c;}var g=c.reduce(function(G,o){var d=U.getLayerIndex(o.layer)||0;G[d]=G[d]||[];G[d].push(o);return G;},[]);return g.reduce(function(c,o){return c.concat(o);});};b.enableFakeConnector=function(s,A,c){s=s||{};function r(){b.enableFakeConnector.original=L.createConnector;L.createConnector=function(){if(!b._oFakeInstance){b._oFakeInstance=new b(s);}return b._oFakeInstance;};}if(A&&c){var o=a.getChangePersistenceForComponent(A,c);if(!(o._oConnector instanceof b)){C.clearEntry(A,c);if(!b._oBackendInstances[A]){b._oBackendInstances[A]={};}b._oBackendInstances[A][c]=o._oConnector;o._oConnector=new b(s);}r();return;}C.clearEntries();if(b.enableFakeConnector.original){return;}r();};b.disableFakeConnector=function(A,s){function r(){if(b.enableFakeConnector.original){L.createConnector=b.enableFakeConnector.original;b.enableFakeConnector.original=undefined;b._oFakeInstance=undefined;}}if(A&&s){var c=a.getChangePersistenceForComponent(A,s);if(!(c._oConnector instanceof L)){C.clearEntry(A,s);if(b._oBackendInstances[A]&&b._oBackendInstances[A][s]){c._oConnector=b._oBackendInstances[A][s];b._oBackendInstances[A][s]=undefined;}}r();return;}C.clearEntries();r();};return b;};},true);
