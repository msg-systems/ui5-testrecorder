/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/core/Component','sap/ui/fl/Utils','sap/ui/fl/ChangePersistenceFactory',"sap/base/Log"],function(Component,Utils,ChangePersistenceFactory,Log){'use strict';var PreprocessorImpl=function(){};PreprocessorImpl.prototype.getControllerExtensions=function(c,C,a){if(a){if(!C){Log.warning("No component ID for determining the anchor of the code extensions was passed.");return Promise.resolve([]);}var o=Component.get(C);var A=Utils.getAppComponentForControl(o);if(!Utils.isApplication(A.getManifestObject())){return Promise.resolve([]);}var f=Utils.getComponentClassName(A);var s=Utils.getAppVersionFromManifest(A.getManifest());var b=ChangePersistenceFactory.getChangePersistenceForComponent(f,s);return b.getChangesForComponent().then(function(d){if(!this._mPreloaded){this._mPreloaded={};}if(!this._mPreloaded[C]){this.aCodeExtChanges=[];this._preloadExtensions(d);this._mPreloaded[C]=true;}var e=[];this.aCodeExtChanges.forEach(function(g){var h=g.getDefinition();if(h.content&&c===h.selector.controllerName){e.push(PreprocessorImpl.getExtensionProvider(h));}});return Promise.all(e);}.bind(this));}else{Log.warning("Synchronous extensions are not supported by sap.ui.fl.PreprocessorImpl");return[];}};PreprocessorImpl.prototype._preloadExtensions=function(aChanges){var oCodeExtensions={};var oExtensionProvider;aChanges.forEach(function(oChange){var sChangeType=oChange.getChangeType();var oContent=oChange.getContent();if(sChangeType==="codeExt"&&oContent.code){var sConvertedCodeContent=Utils.asciiToString(oContent.code);eval("oExtensionProvider = function() {"+sConvertedCodeContent+"}");oCodeExtensions[oContent.codeRef]=oExtensionProvider;this.aCodeExtChanges.push(oChange);}}.bind(this));if(Object.keys(oCodeExtensions).length>0){sap.ui.require.preload(oCodeExtensions);}};PreprocessorImpl.getExtensionProvider=function(c){return new Promise(function(r){var C=c.content.codeRef;var f=C.substr(0,C.lastIndexOf("."));sap.ui.require([f],function(e){r(e);},function(e){Utils.log.error("Code Extension not found",e.message);r({});});});};return PreprocessorImpl;},true);
